<!doctype html>
<html>
    <head>
		<meta charset="utf-8">
        <script type="text/javascript" src="js/d3.v3.js"></script>
		<script type="text/javascript" src="js/index.js"></script>
		<script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
		<script type="text/javascript" src="js/d3.slider.js"></script>
		<script type="text/javascript" src="js/eol-gbif.js"></script>
		<script type="text/javascript" src="js/creatureMapping.js"></script>
		<script type="text/javascript" src="js/lightbox.js"></script>
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		<link rel="stylesheet" type="text/css" href="css/lightbox.css"/>
		<link rel="stylesheet" type="text/css" href="css/d3.slider.css" media="screen"/>
    </head>

		
    <body>
		<script>
		$(document).ready(function(){
			var leftOffset = parseInt($(".CreaturesBox").css("min-width").replace("px", ''));
			var topOffset = parseInt($("#titleBox").css("height").replace("px", ''));
			
			$(".chartContainer").css("width", function() {
				return window.innerWidth - leftOffset + "px";
			});
			
			
			var myLightBox = LightBox.init();
			var popUpHeight = parseInt($("#lightBox .lightBoxContent").css("height").replace("px", ''));
			
			var chart = SpeciesMap.init({
				divSelector: ".chartContainer",
				xPadding: 0,
				yPadding: 0,
				width: d3.select(".chartContainer").node().getBoundingClientRect().width,
				height: d3.select(".chartContainer").node().getBoundingClientRect().height
			});

			//set up callbacks for chart actions
			chart.onCreatureClick(function(e, creature) {
				
				console.log(creature);				
				var boxX = parseInt(creature.drawX + creature.width) + leftOffset;
				var boxY = parseInt(creature.drawY + creature.height) + topOffset;
				
				if(boxY + popUpHeight > window.innerHeight) boxY -= popUpHeight;
				
				myLightBox.xPos(boxX);
				myLightBox.yPos(boxY);
				
				var infoBox = $(".InfoBox");
				
				//add name
				$(infoBox).find("#nameBox").text(creature.name);
				//add cluster details
				$(infoBox).find("#clusterInfo").text(function() {
					var numCreatures = creature.inCluster.length + 1;
					return 	numCreatures + " remains";	
				});
				
				$(infoBox).find("#eolURL").attr("href", "http://eol.org/pages/###/overview".replace("###", creature.id));
			
				myLightBox.show($(infoBox).html());	
			});
			
			//clear creatures list when new creatures are to be instantiated
			chart.onCreatureStartUpdate(function(e, s) {
				//$(".CreaturesList").empty();
			});
			
			//update creature listing as creatures are instantiated
			chart.onCreatureUpdate(function(append, c) {
				if(append) {
					var nameEntry = $(document.createElement("p"))
						.attr("class", "creatureFilter")
						.attr("data-filter-id", c.id)
						.attr("sort", c.name).text(c.name);


					//if list is empty, just add the creature
					if (!$(".creatureFilter").length) {
						console.log("empty list!");
						$(".CreaturesList").append(nameEntry);
						return; 
					}
					
					//otherwise, do binary search to find insertion point
					//code taken from 
					//http://stackoverflow.com/questions/14495400/jquery-insert-div-at-right-place-in-list-of-divs
					//cause I'm lazy
					var sortval = c.name;
					var $first = $(".creatureFilter:first");
					if (sortval <= $first.attr('sort')) {
					   	nameEntry.insertBefore($first);
						return;
					}

					var $last = $(".creatureFilter:last");
					if (sortval >= $last.attr('sort')) {
					   nameEntry.insertAfter($last);
						return;
					}

					var count = 0;
					var $div = $(".creatureFilter");
					do {
					   var index = parseInt($div.length / 2)
					   var $compare = $div.eq(index);
					   var compare = $compare.attr('sort');
					   if (sortval == compare) {
						  break;
					   }
					   else if (sortval < compare) {
						  $div = $div.slice(index, $div.length);
					   }
					   else {
						  $div = $div.slice(0, index);
					   }
					}
					while ($div.length > 1);
					
					if (sortval <= compare) { nameEntry.insertBefore($compare); }
					else { nameEntry.insertAfter($compare); }
					
					
				} else {
					$('[data-filter-id="' + c.id + '"]').remove();
				}
			});
			
			
			
			//Tick formatter
			var formatter = d3.format(",.0f");
			//Initialize slider
			slider = d3.slider()
							.min(-250)
							.max(0)
							//.ticks(227)
							.tickValues([-250, -205, -180, -159, -144, -98, -65, 0])
							//.stepValues([-250, -240, -230, -220, -210, -200, -190, -180, -170, -160, -150, -140, -130, -120, -110, -100, -90, -80, -70, -60, -50, -40, -30, -20, -10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0])
							.showRange(false)
							.value(-0.01)
							.tickFormat(function(d) {
								return -formatter(d) + "mya";
							});
			//Render the slider into the div
			d3.select("#slider").call(slider);

			//Set the current and previous slider values
			currentSliderVal = -slider.value();
			previousSliderVal = -slider.value();


			chart.loadData();
			setChart(chart);
			
			//set listener to filter stuff
			$('.CreaturesList').on('click', '.creatureFilter', function() {
				console.log("click");
				$(this).toggleClass('CreatureListOff');
				chart.toggleSpecie($(this).attr('data-filter-id'));
			});
			
			
			
		});
		</script>

		<div id="titleBox">
			<p>Test Title</p>
		</div>

		<div class="PageContent">
			<div class="CreaturesBox">
				<div class="CreaturesList"></div>
			</div>

			<div class="chartContainer"></div>
		</div>
		<div id="slider"></div>
		
		
		<!--HTML for our dinosaur popup-->
		<div class="HiddenInfoBox">
			<div class="InfoBox">
				<div id="nameBox"></div>
				<div id="picture"></div>
				<div id="clusterInfo"></div>
				<div id="specieInfo"></div>
				<ul id="clusterList"></ul>
				<a href="#" id="eolURL" target="_blank">View Encyclopedia Page</a>
			</div>
		</div>
    </body>
</html>